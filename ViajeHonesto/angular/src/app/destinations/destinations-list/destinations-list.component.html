<div class="container-fluid">
  <div class="card shadow-sm">
    <div class="card-header">
      <h1 class="card-title m-0 text-primary">
        <i class="fas fa-map-marked-alt me-2"></i>
        {{ '::Menu:Destinations' | abpLocalization }}
      </h1>
      <hr class="mt-2 mb-0" />
    </div>

    <div class="card-body m-3 mt-0">
      <div class="row g-2 align-items-end mb-3" role="search">
        <!-- Búsqueda -->
        <div class="col-12 col-md">
          <label for="search-query" class="form-label text-truncate">
            {{ '::Destinations:SearchQuery' | abpLocalization }}
          </label>
          <input
            id="search-query"
            name="cityName"
            type="search"
            class="form-control"
            (keyup.enter)="onSearch()"
            [(ngModel)]="searchParams.partialCityName"
            [placeholder]="'::Destinations:SearchPlaceholder' | abpLocalization"
          />
        </div>

        <!-- Ordenamiento -->
        <div class="col-12 col-md-3">
          <label for="sort-select" class="form-label text-truncate">
            {{ '::Destinations:SortBy' | abpLocalization }}
          </label>
          <select
            id="sort-select"
            class="form-select"
            [(ngModel)]="searchParams.sort"
            (change)="onSearch()"
          >
            @for (option of sortOptions; track option) {
              <option [value]="option.value">
                {{ option.label | abpLocalization }}
              </option>
            }
          </select>
        </div>

        <!-- Botones -->
        <div class="col-12 col-md-auto">
          <div class="d-flex gap-1 text-nowrap">
            <button
              type="button"
              class="btn"
              [ngClass]="!isFilterCollapsed ? 'btn-outline-secondary' : 'btn-secondary'"
              (click)="isFilterCollapsed = !isFilterCollapsed"
              [attr.aria-expanded]="!isFilterCollapsed"
              title="{{ '::Filter' | abpLocalization }}"
            >
              <i class="fa fa-filter"></i>
              <span class="d-none d-lg-inline ms-1">{{ '::Filter' | abpLocalization }}</span>
            </button>

            <button
              type="button"
              class="btn btn-primary flex-grow-1"
              (click)="onSearch()"
              [disabled]="loading || !isPopulationValid"
              title="{{ '::Search' | abpLocalization }}"
            >
              <i class="fa fa-search"></i>
              <span class="ms-1">{{ '::Search' | abpLocalization }}</span>
            </button>

            <button
              type="button"
              class="btn btn-danger"
              (click)="clearSearch()"
              [disabled]="!searchParams.partialCityName && destinations.length === 0"
              title="{{ '::Clear' | abpLocalization }}"
            >
              <i class="fa fa-times"></i>
              <span class="d-none d-lg-inline ms-1">{{ '::Clear' | abpLocalization }}</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Filtro de destinos -->
      <div #collapse="ngbCollapse" [(ngbCollapse)]="isFilterCollapsed">
        <div class="card mb-0 pb-2">
          <div class="card-body bg-secondary-subtle border-0">
            <div class="row g-3">
              <!-- País -->
              <div class="col-md-6">
                <label for="country-search" class="form-label">
                  {{ '::Destinations:Country' | abpLocalization }}
                </label>
                <input
                  id="country-search"
                  type="search"
                  class="form-control"
                  [placeholder]="'::Destinations:AllCountries' | abpLocalization"
                  [(ngModel)]="selectedCountry"
                  [ngbTypeahead]="searchCountries"
                  [resultFormatter]="isoNameFormatter"
                  [inputFormatter]="isoNameFormatter"
                  [editable]="false"
                  (selectItem)="onCountrySelect($event)"
                  (blur)="checkCountryClear()"
                  (focus)="countryFocus$.next($any($event).target.value)"
                  (click)="countryClick$.next($any($event).target.value)"
                />
              </div>

              <!-- Región -->
              <div class="col-md-6">
                <label for="region-search" class="form-label">
                  {{ '::Destinations:Region' | abpLocalization }}
                </label>
                <input
                  id="region-search"
                  type="search"
                  class="form-control"
                  [disabled]="!searchParams.countryCode"
                  [placeholder]="'::Destinations:AllRegions' | abpLocalization"
                  [(ngModel)]="selectedRegion"
                  [ngbTypeahead]="searchRegions"
                  [resultFormatter]="isoNameFormatter"
                  [inputFormatter]="isoNameFormatter"
                  [editable]="false"
                  (selectItem)="onRegionSelect($event)"
                  (blur)="checkRegionClear()"
                  (focus)="regionFocus$.next($any($event).target.value)"
                  (click)="regionClick$.next($any($event).target.value)"
                />
              </div>

              <!-- Población mínima -->
              <div class="col-md-3">
                <label for="min-pop" class="form-label">
                  {{ '::Destinations:MinPopulation' | abpLocalization }}
                </label>
                <input
                  id="min-pop"
                  type="text"
                  inputmode="numeric"
                  class="form-control"
                  (input)="onPopulationInput('min', $event)"
                  [class.is-invalid]="!isPopulationValid"
                  min="0"
                />
              </div>

              <!-- Población máxima -->
              <div class="col-md-3">
                <label for="max-pop" class="form-label">
                  {{ '::Destinations:MaxPopulation' | abpLocalization }}
                </label>
                <input
                  id="max-pop"
                  type="text"
                  inputmode="numeric"
                  class="form-control"
                  (input)="onPopulationInput('max', $event)"
                  [class.is-invalid]="!isPopulationValid"
                  min="0"
                />
              </div>

              <!-- Mensaje de error -->
              @if (!isPopulationValid) {
                <div class="col-12">
                  <div class="text-danger small">
                    <i class="fa fa-exclamation-circle me-1"></i>
                    {{ '::Destinations:PopulationRangeError' | abpLocalization }}
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Grid de destinos -->
      <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 pt-1">
        @for (destination of destinations; track destination) {
          <div class="col">
            <div class="card h-100 border shadow-sm">
              <div class="card-body pb-1">
                <!-- Encabezado de la tarjeta individual -->
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <h5 class="card-title fw-bold text-dark mb-0 w-75">{{ destination.name }}</h5>
                  <span class="badge bg-info text-dark rounded-pill text-wrap">{{
                    destination.country
                  }}</span>
                </div>

                <h6 class="card-subtitle text-muted mb-3">
                  <i class="fas fa-map-pin me-1 small"></i>{{ destination.region }}
                </h6>

                <!-- Dato destacado (Población) -->
                <div class="d-flex align-items-center mt-3 pt-3 border-top">
                  <div class="flex-grow-1">
                    <small class="text-uppercase text-secondary fw-bold">
                      {{ '::Population' | abpLocalization }}
                    </small>
                    <div class="fs-5 fw-normal text-dark">
                      {{ destination.population | number }}
                    </div>
                  </div>
                  <div class="text-muted opacity-25">
                    <i class="fas fa-users fa-2x"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Paginación -->
      @if (destinations.length > 0) {
        <div class="mt-4 d-flex justify-content-center">
          <ngb-pagination
            [collectionSize]="totalCount"
            [page]="currentPage"
            [pageSize]="searchParams.resultLimit"
            [maxSize]="5"
            [rotate]="true"
            [ellipses]="false"
            [boundaryLinks]="true"
            [disabled]="loading"
            (pageChange)="onPageChange($event)"
          ></ngb-pagination>
        </div>
      }

      <!-- Mensaje cuando no hay resultados -->
      @if (!loading && destinations.length === 0 && submitted && !errorMessage) {
        <div class="alert alert-info mt-4 d-flex flex-column">
          <div class="d-flex align-items-center mb-2">
            <i class="fa fa-search fa-3x me-3"></i>
            <h2 class="mb-0">{{ '::Destinations:NoResults' | abpLocalization }}</h2>
          </div>
          <p class="mb-0">{{ '::Destinations:NoResultsMessage' | abpLocalization }}</p>
        </div>
      }

      <!-- Mensajes de error -->
      @if (errorMessage) {
        <div class="alert alert-danger mt-4">
          {{ errorMessage | abpLocalization }}
        </div>
      }

      <!-- Indicador de carga -->
      @if (loading) {
        <div
          class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75 rounded"
        >
          <div class="spinner-border text-primary" role="status">
            <span class="sr-only">{{ '::Loading' | abpLocalization }}</span>
          </div>
        </div>
      }
    </div>
  </div>
</div>
